@model IEnumerable<UniversiteProjeYonetimSistemi.Models.Proje>

@{
    ViewData["Title"] = "Danışmanlık Yaptığım Projeler";
    var secilenDurum = ViewBag.SecilenDurum as string ?? "";
}

<div class="container py-4">
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h1 class="mb-0">Danışmanlık Yaptığım Projeler</h1>
        </div>
        <div class="col-md-4 text-md-end">
            <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Panele Dön
            </a>
        </div>
    </div>

    <!-- Özet Kartları -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <a asp-action="Danismanliklar" style="text-decoration: none;">
                <div class="card @(string.IsNullOrEmpty(secilenDurum) ? "bg-primary text-white" : "border-primary") h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-0">Tüm Projeler</h5>
                        <h1 class="display-4 mt-2">@ViewBag.TumProjeSayisi</h1>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-3">
            <a asp-action="Danismanliklar" asp-route-durum="Devam" style="text-decoration: none;">
                <div class="card @(secilenDurum == "Devam" ? "bg-info text-white" : "border-info") h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-0">Devam Eden</h5>
                        <h1 class="display-4 mt-2">@ViewBag.DevamEdenProjeSayisi</h1>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-3">
            <a asp-action="Danismanliklar" asp-route-durum="Beklemede" style="text-decoration: none;">
                <div class="card @(secilenDurum == "Beklemede" ? "bg-warning text-white" : "border-warning") h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-0">Beklemede</h5>
                        <h1 class="display-4 mt-2">@ViewBag.BeklemedeProjeSayisi</h1>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-3">
            <a asp-action="Danismanliklar" asp-route-durum="Tamamlandi" style="text-decoration: none;">
                <div class="card @(secilenDurum == "Tamamlandi" ? "bg-success text-white" : "border-success") h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-0">Tamamlanan</h5>
                        <h1 class="display-4 mt-2">@ViewBag.TamamlananProjeSayisi</h1>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Proje Listesi -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        @if (!string.IsNullOrEmpty(secilenDurum))
                        {
                            <span>@secilenDurum Durumundaki Projeler</span>
                        }
                        else
                        {
                            <span>Tüm Projeler</span>
                        }
                    </h5>
                    @if (!string.IsNullOrEmpty(secilenDurum))
                    {
                        <a asp-action="Danismanliklar" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-filter"></i> Filtreyi Temizle
                        </a>
                    }
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Proje Adı</th>
                                    <th>Öğrenci</th>
                                    <th>Durum</th>
                                    <th>Son Güncelleme</th>
                                    <th class="text-center">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Any())
                                {
                                    @foreach (var proje in Model.OrderByDescending(p => p.UpdatedAt))
                                    {
                                        <tr>
                                            <td class="fw-bold">@proje.Ad</td>
                                            <td>
                                                @if (proje.Ogrenci != null)
                                                {
                                                    <span>@proje.Ogrenci.Ad @proje.Ogrenci.Soyad</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @{
                                                    string statusBadgeClass = "";
                                                    switch (proje.Status)
                                                    {
                                                        case "Beklemede": statusBadgeClass = "bg-warning"; break;
                                                        case "Atanmis": statusBadgeClass = "bg-info"; break;
                                                        case "Devam": statusBadgeClass = "bg-primary"; break;
                                                        case "Tamamlandi": statusBadgeClass = "bg-success"; break;
                                                        case "Iptal": statusBadgeClass = "bg-danger"; break;
                                                        default: statusBadgeClass = "bg-secondary"; break;
                                                    }
                                                }
                                                <span class="badge @statusBadgeClass">@proje.Status</span>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    @proje.UpdatedAt.ToString("dd.MM.yyyy HH:mm")
                                                </small>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group">
                                                    <a asp-controller="Proje" asp-action="Details" asp-route-id="@proje.Id" class="btn btn-sm btn-outline-info" title="Proje Sayfası">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a asp-action="DegerlendirmeOlustur" asp-route-projeId="@proje.Id" class="btn btn-sm btn-outline-success" title="Değerlendir">
                                                        <i class="fas fa-star"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-5">
                                            <div class="text-center">
                                                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                                                @if (!string.IsNullOrEmpty(secilenDurum))
                                                {
                                                    <p>@secilenDurum durumunda hiç projeniz bulunmuyor.</p>
                                                    <a asp-action="Danismanliklar" class="btn btn-primary">Tüm Projeleri Göster</a>
                                                }
                                                else
                                                {
                                                    <p>Henüz danışmanlık yaptığınız herhangi bir proje bulunmuyor.</p>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sağ Panel -->
        <div class="col-lg-4">
            <!-- Yaklaşan Teslim Tarihleri -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Yaklaşan Teslim Tarihleri</h5>
                </div>
                <div class="card-body">
                    @if (ViewBag.YaklasanTeslimler != null && ViewBag.YaklasanTeslimler.Count > 0)
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var proje in ViewBag.YaklasanTeslimler)
                            {
                                // Proje.TeslimTarihi nullable DateTime? olarak tanımlanmış ama ViewBag'de farklı tipe dönüşebiliyor
                                // Her ihtimale karşı bu kısmı güvenli şekilde yazalım
                                DateTime teslimTarihi;
                                int kalanGun;
                                string badgeClass;
                                
                                try 
                                {
                                    teslimTarihi = Convert.ToDateTime(proje.TeslimTarihi);
                                    kalanGun = (teslimTarihi - DateTime.Today).Days;
                                    badgeClass = kalanGun <= 3 ? "danger" : (kalanGun <= 7 ? "warning" : "info");
                                }
                                catch
                                {
                                    // Herhangi bir hata durumunda varsayılan değerleri kullan
                                    kalanGun = 0;
                                    badgeClass = "secondary";
                                }
                                
                                <a href="@Url.Action("ProjeDetay", new { id = proje.Id })" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@proje.Ad</h6>
                                        <span class="badge bg-@badgeClass">@kalanGun gün</span>
                                    </div>
                                    <p class="mb-1">
                                        @if (proje.Ogrenci != null)
                                        {
                                            @proje.Ogrenci.Ad @proje.Ogrenci.Soyad
                                        }
                                    </p>
                                    <small>Teslim: @(proje.TeslimTarihi != null ? Convert.ToDateTime(proje.TeslimTarihi).ToString("dd.MM.yyyy") : "-")</small>
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                            <p class="text-muted">İki hafta içinde teslim tarihi olan proje bulunmuyor.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Son Değerlendirmelerim -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Son Değerlendirmelerim</h5>
                </div>
                <div class="card-body">
                    @if (ViewBag.SonDegerlendirmeler != null && ViewBag.SonDegerlendirmeler.Count > 0)
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var degerlendirme in ViewBag.SonDegerlendirmeler)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-1">@degerlendirme.Proje.Ad</h6>
                                        <span class="badge bg-info">@degerlendirme.Puan / 100</span>
                                    </div>
                                    <p class="mb-1">@degerlendirme.Aciklama</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">@degerlendirme.DegerlendirmeTipi</small>
                                        <small class="text-muted">@degerlendirme.CreatedAt.ToString("dd.MM.yyyy")</small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Henüz değerlendirme yapmadınız.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div> 